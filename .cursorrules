# AI Systems Architect — Course Platform

A self-hosted course delivery platform with video lessons, Stripe subscriptions, and automated email sequences.

## Tech Stack

- Framework: Next.js 14 (App Router)
- Language: TypeScript
- Database: PostgreSQL (Neon)
- ORM: Prisma
- Styling: Tailwind CSS + shadcn/ui
- Auth: NextAuth.js (database sessions)
- Payments: Stripe (Checkout + Customer Portal)
- Video: Mux (HLS streaming, signed URLs)
- Email: Mailgun
- Deployment: Vercel

## CRITICAL RULES

1. **Video 1 is FREE** — isFree flag on Lesson model, always check before paywall
2. **Module gating is SEQUENTIAL** — must complete Module N before N+1 unlocks
3. **Subscription events from WEBHOOKS ONLY** — never trust client redirect
4. **accessOverride BEATS subscription** — check override first in hasAccess()
5. **Email queue checks state at SEND TIME** — user may have converted since queue
6. **All prices in PENCE** — £49 = 4900, £399 = 39900 for Stripe
7. **Mux URLs are SIGNED** — expire after 1 hour, generate fresh on each request
8. **Marketing emails respect OPT-OUT** — transactional always send
9. **Progress is BINARY** — complete or not, no partial video tracking
10. **Events track on SERVER for payments** — client events can be missed

## Security Rules

### Secrets & Environment

- NEVER hardcode API keys, secrets, or credentials
- ALL sensitive values from environment variables
- NEVER log secrets or include in error messages
- NEVER commit .env files (only .env.example)

### Authentication & Authorization

- ALWAYS check auth on protected API routes
- ALWAYS verify user permission before data operations
- Use middleware for auth checks, not inline code
- Session tokens: httpOnly, secure, sameSite

### Data Access

- ALWAYS filter queries by userId (prevent IDOR)
- Check ownership before update/delete
- Rate limit authentication endpoints

### Webhook Security

- ALWAYS validate Stripe webhook signatures
- ALWAYS validate Vercel cron secret headers
- Process webhooks idempotently (handle duplicates)

### Error Handling

- NEVER expose stack traces to users in production
- Log errors server-side with context
- Return consistent error formats

## Technology Choices

- Use NextAuth.js, NOT Clerk/Auth0 — self-hosted, no per-user pricing
- Use Prisma, NOT Drizzle — more mature, better docs
- Use Mailgun, NOT Resend — reliable deliverability, good pricing
- Use Mux, NOT Cloudflare Stream — better DX, signed URLs built-in
- Use shadcn/ui, NOT Material UI — lighter, more customizable
- Use database sessions, NOT JWT — allows revocation

## Common Mistakes to Avoid

- Tracking subscription_started on redirect → Track in webhook only
- Checking subscription before accessOverride → Check override FIRST
- Sending abandonment emails to subscribers → Re-check status at send time
- Using unsigned Mux URLs → Always generate signed URLs
- Storing Stripe amounts as pounds → Always use pence (integer)
- Hardcoding "Video 1" by ID → Check isFree flag on Lesson
- Calculating progress with unpublished lessons → Filter published: true
- Creating duplicate welcome emails → Check EmailLog before sending
- Module unlock by order number → Use sequential published module logic
- MRR including PAST_DUE subscriptions → Only count ACTIVE status

## File Organisation

- /app — Next.js App Router pages and API routes
- /components — React components (ui/ for shadcn)
- /lib — Utilities, services, helpers
- /prisma — Schema and migrations
- /emails — Email templates

## Dependency Rules

- Install packages with `pnpm add [package]` — no pinned versions
- Check `pnpm outdated` before starting new chunks
- Do not add analytics packages (custom Event table)
- Do not add community/forum packages (using Discord)

## Documentation Reference

- Architecture decisions: see ARCHITECTURE.md
- Database schema: see DATABASE_SCHEMA.md
- API integrations: see API_CONTRACTS.md
- Task navigation: see TASK_ROUTER.md
